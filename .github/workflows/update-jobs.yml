name: Update Jobs from Aggregator

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main ]
    paths:
      - '.github/scripts/job-fetcher/**'
      - '.github/scripts/write-current-jobs.js'

# Prevent concurrent runs to avoid git conflicts
concurrency:
  group: job-updates-${{ github.repository }}
  cancel-in-progress: false

jobs:
  update-jobs:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref_name }}
        fetch-depth: 1
        submodules: recursive
        token: ${{ secrets.GH_PAT }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install axios

    - name: Fetch and update jobs
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        mkdir -p .github/logs .github/data
        ALL_JOBS_SHA=$(curl -sf -H "Authorization: token $GH_PAT" \
          "https://api.github.com/repos/zapplyjobs/jobs-data-2026/commits/main" \
          | node -e "let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>{try{console.log(JSON.parse(d).sha)}catch(e){console.log('unknown')}})" \
          || echo "unknown")
        export ALL_JOBS_SHA
        node .github/scripts/job-fetcher/index.js 2>&1 | tee .github/logs/job-fetcher.log

    - name: Write current_jobs.json for aggregator
      run: |
        mkdir -p .github/data
        node .github/scripts/write-current-jobs.js

    - name: Count-drop alert
      env:
        DISCORD_TEAM_TOKEN: ${{ secrets.DISCORD_TEAM_TOKEN }}
        DISCORD_ALERT_CHANNEL_ID: "1477002891234512916"
        REPO_NAME: New-Grad-Software-Engineering-Jobs-2026
      run: |
        mkdir -p .github/data
        export CURR_COUNT=$(grep -o "Total_Jobs-[0-9]*" README.md | grep -o "[0-9]*" || echo "0")
        node -e "
          const fs = require('fs');
          const https = require('https');
          const curr = parseInt(process.env.CURR_COUNT || '0', 10);
          const lastPath = '.github/data/last_count.json';
          const prev = fs.existsSync(lastPath) ? JSON.parse(fs.readFileSync(lastPath)).count : null;
          fs.writeFileSync(lastPath, JSON.stringify({ count: curr, timestamp: new Date().toISOString() }));
          const isZero = curr === 0;
          const isDrop = prev !== null && curr < prev * 0.5;
          if (!isZero && !isDrop) { console.log('Count OK: ' + curr + (prev !== null ? ' (prev: ' + prev + ')' : '')); process.exit(0); }
          const reason = isZero ? 'Job count hit 0' : 'Job count dropped >' + Math.round((1 - curr/prev)*100) + '% (' + prev + ' → ' + curr + ')';
          console.warn('ALERT: ' + reason);
          if (!process.env.DISCORD_TEAM_TOKEN || !process.env.DISCORD_ALERT_CHANNEL_ID) { console.error('Discord secrets not set — alert suppressed'); process.exit(0); }
          const body = JSON.stringify({ embeds: [{ title: '⚠️ Consumer Count Drop', color: 0xe74c3c, description: '**' + process.env.REPO_NAME + '**: ' + reason, footer: { text: new Date().toISOString() } }] });
          const req = https.request({ hostname: 'discord.com', path: '/api/v10/channels/' + process.env.DISCORD_ALERT_CHANNEL_ID + '/messages', method: 'POST', headers: { 'Authorization': 'Bot ' + process.env.DISCORD_TEAM_TOKEN, 'Content-Type': 'application/json', 'Content-Length': Buffer.byteLength(body) } }, res => { console.log('Discord response: ' + res.statusCode); });
          req.on('error', e => console.error('Discord request failed: ' + e.message));
          req.write(body); req.end();
        "

    - name: Display job-fetcher logs (always run)
      if: always()
      run: |
        echo "Job Fetcher Output (last 100 lines):"
        tail -100 .github/logs/job-fetcher.log || echo "Log file not found"

    - name: Display public status
      run: |
        echo "Job collection completed"
        if [ -f "README.md" ]; then
          JOB_COUNT=$(grep -o "Total_Jobs-[0-9]*" README.md | grep -o "[0-9]*" || echo "0")
          echo "Total positions: $JOB_COUNT"
        fi

    - name: Check for changes
      id: verify-changed-files
      run: |
        echo "Git status:"
        git status --porcelain
        echo ""

        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Found changes in files"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        fi

    - name: Commit and Push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        commit_and_push() {
          local max_attempts=5
          local delay=5

          for attempt in $(seq 1 $max_attempts); do
            echo "Attempt $attempt of $max_attempts"

            git pull origin ${{ github.ref_name }} --no-edit || {
              echo "Pull had conflicts, resetting..."
              git reset --hard HEAD
            }

            git add README.md .github/data/current_jobs.json .github/data/new_jobs.json .github/data/last_count.json .github/data/run_metrics.json .github/logs/ || true

            JOB_COUNT=$(grep -o "Total_Jobs-[0-9]*" README.md | grep -o "[0-9]*" || echo "0")

            COMMIT_MSG="Update jobs - $(date +'%Y-%m-%d %H:%M UTC') | Found $JOB_COUNT software engineering positions"

            if ! git commit -m "$COMMIT_MSG"; then
              echo "Commit failed, may already be committed"
            fi

            if git push origin ${{ github.ref_name }}; then
              echo "Successfully pushed changes!"
              exit 0
            else
              echo "Push failed — retrying in ${delay}s..."
              git reset --soft HEAD~1
              sleep $delay
              delay=$((delay * 2))
            fi
          done

          echo "Failed to push after $max_attempts attempts"
          exit 1
        }

        commit_and_push

    - name: Create job summary
      run: |
        echo "## Jobs Updated!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          JOB_COUNT=$(grep -o "Total_Jobs-[0-9]*" README.md | grep -o "[0-9]*" || echo "0")

          echo "Successfully updated software engineering job board" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Today's Update:" >> $GITHUB_STEP_SUMMARY
          echo "- **$JOB_COUNT total software engineering positions** from centralized aggregator" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next update**: In ~15 minutes" >> $GITHUB_STEP_SUMMARY
        else
          echo "No changes detected - job board is current" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next check**: In ~15 minutes" >> $GITHUB_STEP_SUMMARY
        fi
