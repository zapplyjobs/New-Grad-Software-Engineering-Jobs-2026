name: Update Jobs

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main ]
    paths:
      - '.github/scripts/job-fetcher/**'
      - '.github/data/**'

jobs:
  update-jobs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # NOTE: Scraping and Discord bot steps removed - preserved in backup
    # To restore: See Job_Listings/scraper-code-backup/Hardware/

    - name: Regenerate README from existing job data
      working-directory: .github/scripts/job-fetcher
      run: |
        echo "Regenerating README from existing job data..."
        node readme-generator.js
        echo "README regeneration complete"

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Found changes in README"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        fi

    - name: Commit updated job board
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "admin@zapply.jobs"
        git config --local user.name "Zapply Team"
        git add -A

        # Get job count from README for commit message
        JOB_COUNT=$(grep -o "Total_Jobs-[0-9]*" README.md | grep -o "[0-9]*" || echo "0")
        COMPANY_COUNT=$(grep -o "Companies-[0-9]*" README.md | grep -o "[0-9]*" || echo "0")

        git commit -m "Update jobs - $(date +'%Y-%m-%d')

        Found $JOB_COUNT positions from $COMPANY_COUNT companies
        Updated categories, locations, and experience levels"

    - name: Pull latest changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "Pulling latest changes with rebase strategy..."
        git fetch origin main
        git rebase origin/main --strategy-option=ours || git merge -X ours origin/main --no-edit
        echo "Pull completed successfully"

    - name: Push updated changes with retry logic
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "Pushing changes with retry logic..."
        for i in 1 2 3; do
          echo "Push attempt $i of 3..."
          if git push origin main; then
            echo "Successfully pushed changes"
            break
          else
            echo "Push failed - pulling latest changes before retry..."
            git pull origin main --rebase --autostash || git pull origin main --no-edit
            sleep 5
          fi
        done

    - name: Create job summary
      run: |
        echo "## ðŸš€ Jobs Updated!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          # Extract stats from README
          JOB_COUNT=$(grep -o "Total_Jobs-[0-9]*" README.md | grep -o "[0-9]*" || echo "0")
          COMPANY_COUNT=$(grep -o "Companies-[0-9]*" README.md | grep -o "[0-9]*" || echo "0")

          echo "âœ… **Successfully updated job board**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Statistics:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ **$JOB_COUNT total positions**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¢ **$COMPANY_COUNT companies** tracked" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”„ Next update**: Tomorrow at 9 AM UTC" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **No changes detected**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Job board is already up to date." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”„ Next check**: Tomorrow at 9 AM UTC" >> $GITHUB_STEP_SUMMARY
        fi
